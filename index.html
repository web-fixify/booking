<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fixify Repairing service booking</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/milligram@1.4.1/dist/milligram.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <div class="progress-bar">
      <div class="progress"></div>
    </div>
    
    <form id="myForm" action="#" method="POST">
      <fieldset class="active">
        <h2>Information</h2>
        <input type="text" name="firstName" placeholder="First Name" required>
        <input type="text" name="lastName" placeholder="Last Name" required>
        <input type="email" name="email" placeholder="Email" required>
        <input type="tel" name="phoneNumber" placeholder="Phone Number" required>
        <input type="tel" name="secondPhoneNumber" placeholder="Second Phone Number">
        <button class="next">Next</button>
      </fieldset>
      
      <fieldset>
        <h2>Service</h2>
        <select name="service" id="serviceSelect" required>
          <option value="">Select Service</option>
          <option value="Mobile Repairing">Mobile Repairing</option>
          <option value="TV Repairing">TV Repairing</option>
          <option value="AC Repairing">AC Repairing</option>
        </select>
        <input type="text" name="company" placeholder="Company" required>
        <input type="text" name="model" placeholder="Model" required>
        <textarea name="problemDescription" placeholder="Explain Your Problem" required></textarea>
        <div id="additionalOptions" style="display: none;">
          <h3>Additional Options:</h3>
          <label><input type="checkbox" name="problem" value="Display Broken">Display Broken</label>
          <label><input type="checkbox" name="problem" value="Battery Problem">Battery Problem</label>
          <label><input type="checkbox" name="problem" value="Front Camera Problem">Front Camera Problem</label>
          <label><input type="checkbox" name="problem" value="Backup Camera Problem">Backup Camera Problem</label>
          <label><input type="checkbox" name="problem" value="Charging Pin Problem">Charging Pin Problem</label>
          <label><input type="checkbox" name="problem" value="Other">Other</label>
        </div>
        <button class="previous">Previous</button>
        <button class="next">Next</button>
      </fieldset>
      
      <fieldset>
        <h2>Images link</h2>
        <input type="file" id="frontImageUpload" required>
        <input type="file" id="backImageUpload" required>
        <button class="previous">Previous</button>
        <button type="button" onclick="uploadImages()">Upload Images</button>
        <img id="frontImagePreview" src="#" alt="Front Image" style="display: none; max-width: 200px; max-height: 200px;">
        <img id="backImagePreview" src="#" alt="Back Image" style="display: none; max-width: 200px; max-height: 200px;">
        <span id="uploadStatus" style="display: none;">✔ Images Uploaded</span>
      </fieldset>
    </form>

    <div class="popup" id="popup">
      <img src="done.gif" alt="GIF">
      <button id="doneButton">Done</button>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const form = document.getElementById('myForm');
    const fieldsets = form.querySelectorAll('fieldset');
    const progressBar = document.querySelector('.progress');
    const popup = document.getElementById('popup');
    const doneButton = document.getElementById('doneButton');
    const serviceSelect = document.getElementById('serviceSelect');
    const additionalOptions = document.getElementById('additionalOptions');
    const frontImageUpload = document.getElementById('frontImageUpload');
    const backImageUpload = document.getElementById('backImageUpload');
    const frontImagePreview = document.getElementById('frontImagePreview');
    const backImagePreview = document.getElementById('backImagePreview');
    const uploadStatus = document.getElementById('uploadStatus');

    let currentFieldset = 0;
    updateProgress();

    function updateProgress() {
      const percent = ((currentFieldset + 1) / fieldsets.length) * 100;
      progressBar.style.width = percent + '%';
    }

    function showFieldset(index) {
      fieldsets.forEach((fieldset, i) => {
        fieldset.classList.toggle('active', i === index);
      });
    }

    function nextFieldset() {
      if (validateFields(currentFieldset)) {
        if (currentFieldset < fieldsets.length - 1) {
          currentFieldset++;
          showFieldset(currentFieldset);
          updateProgress();
        }
      }
    }

    function previousFieldset() {
      if (currentFieldset > 0) {
        currentFieldset--;
        showFieldset(currentFieldset);
        updateProgress();
      }
    }

    function validateFields(index) {
      const currentInputs = fieldsets[index].querySelectorAll(
        'input[required], textarea[required], select[required]'
      );

      let isValid = true;

      currentInputs.forEach((input) => {
        if (input.value.trim() === '') {
          isValid = false;
          input.classList.add('error');
        } else {
          input.classList.remove('error');
        }
      });

      return isValid;
    }

    function prepareEmailMessage(formData) {
      let message = `First Name: ${formData.get('firstName')}
        Last Name: ${formData.get('lastName')}
        Email: ${formData.get('email')}
        Phone Number: ${formData.get('phoneNumber')}
        Second Phone Number: ${formData.get('secondPhoneNumber')}

        Service: ${formData.get('service')}
        Company: ${formData.get('company')}
        Model: ${formData.get('model')}
        Problem: ${formData.get('problemDescription')}

        Image URL: ${formData.get('imageUrl')}
        Back Image URL: ${formData.get('backImageUrl')}
      `;

      return message;
    }

    function uploadImages() {
      const formData = new FormData(form);

      // Check if front image is selected
      if (frontImageUpload.files.length === 0) {
        alert('Please select a front image.');
        return;
      }

      // Check if back image is selected
      if (backImageUpload.files.length === 0) {
        alert('Please select a back image.');
        return;
      }

      // Disable upload button
      const uploadButton = document.querySelector('button[type="button"]');
      uploadButton.disabled = true;

      // Show image upload status
      uploadStatus.style.display = 'inline';

      // Prepare front image data
      const frontImage = frontImageUpload.files[0];
      const frontImageData = new FormData();
      frontImageData.append('image', frontImage);

      // Upload front image
      axios.post('https://api.imgur.com/3/upload', frontImageData, {
        headers: {
          Authorization: 'Client-ID YOUR_IMGUR_CLIENT_ID'
        }
      }).then((response) => {
        const frontImageUrl = response.data.data.link;
        formData.set('imageUrl', frontImageUrl);
        frontImagePreview.src = frontImageUrl;
        frontImagePreview.style.display = 'block';

        // Prepare back image data
        const backImage = backImageUpload.files[0];
        const backImageData = new FormData();
        backImageData.append('image', backImage);

        // Upload back image
        axios.post('https://api.imgur.com/3/upload', backImageData, {
          headers: {
            Authorization: 'Client-ID 2455cb9ff4bc073'
          }
        }).then((response) => {
          const backImageUrl = response.data.data.link;
          formData.set('backImageUrl', backImageUrl);
          backImagePreview.src = backImageUrl;
          backImagePreview.style.display = 'block';
          uploadStatus.textContent = '✔ Images Uploaded';

          // Prepare and send email
          const message = prepareEmailMessage(formData);
          sendEmail(message);
        }).catch((error) => {
          console.error('Error uploading back image:', error);
          alert('An error occurred while uploading the back image.');
          uploadButton.disabled = false;
          uploadStatus.style.display = 'none';
        });
      }).catch((error) => {
        console.error('Error uploading front image:', error);
        alert('An error occurred while uploading the front image.');
        uploadButton.disabled = false;
        uploadStatus.style.display = 'none';
      });
    }

    function sendEmail(message) {
      // Configure SMTPJS with secure token
      Email.send({
        SecureToken: 'babe4a77-804b-4c8f-89e2-263b27a6b624',
        To: 'fixify.contact@gmail.com',
        From: 'fixify.contact@gmail.com',
        Subject: 'Form Submission',
        Body: message
      }).then(() => {
        // Show popup and hide form
        form.reset();
        form.style.display = 'none';
        popup.style.display = 'flex';
      }).catch((error) => {
        // Show error message
        console.error('Error sending email:', error);
        alert('An error occurred while submitting the form.');
      });
    }

    doneButton.addEventListener('click', function () {
      location.reload();
    });

    const nextButtons = document.querySelectorAll('button.next');
    const previousButtons = document.querySelectorAll('button.previous');

    nextButtons.forEach((button) => {
      button.addEventListener('click', nextFieldset);
    });

    previousButtons.forEach((button) => {
      button.addEventListener('click', previousFieldset);
    });

    serviceSelect.addEventListener('change', function () {
      if (serviceSelect.value === 'Mobile Repairing') {
        additionalOptions.style.display = 'block';
      } else {
        additionalOptions.style.display = 'none';
      }
    });
  </script>
</body>
</html>
